#### 1 高并发大流量的应对之道

##### 	1.1 分离之道

- 资源分离

  将前端资源分离，部署时可以直接推送到CDN服务器，CDN服务器全国各地都有，用户在访问系统时，可以从就近的CDN服务器上拉取对应的资源，能够极大的增强系统的性能。

- 接口分离

  一个是秒杀接口与其他接口分离，一个是高频访问接口与低频访问接口分离。

  对于秒杀系统的接口来说，在设计上一定要与其他的接口进行分离，不要让秒杀系统的接口与其他业务的接口互相关联引用，避免秒杀系统的瞬时高并发流量对其他接口造成影响。

  就秒杀系统而言，并不是每个接口的访问频次都一样，一般情况下，商品详情页、结算页和秒杀下单接口的访问频次要远远大于支付接口的访问频次。在设计上一定要将这些接口进行区分隔离，对高频访问的接口进行单独的性能优化。

- 数据分离

  一个是秒杀数据和其他数据分离，一个是动态数据与静态数据分离。

  一般情况下，秒杀数据瞬时的增长率会远远大于其他数据，在数据上进行分离，可以对秒杀数据的存储设施进行单独的针对性优化，不能让秒杀数据对其他数据产生影响，在数据层面对秒杀系统进行独有部署。

  动态数据数据在秒杀期间会容易发生更变，比如秒杀系统的品类、商品的库存和上下架的状态等，都是动态数据，这些动态数据对时间比较敏感。而像秒杀结果等于用户本身相关的一些数据，可以称为静态数据，因为这些数据在整个秒杀活动期间，基本不会发生变化。

  在设计上，需要对这些动态数据和静态数据进行分离，因为数据的更新频率不同，在优化手段和架构设计上也会存在着差异。对动态数据和静态数据进行分离后，也可以将服务端产生的静态数据推送到CDN。

- 业务分离

  秒杀业务与其他业务之间做隔离。

- 系统分离

  将秒杀详情页系统、秒杀结算页系统、购物车系统和订单系统进行隔离，申请单独的域名和负载均衡器，对相应的微服务集群进行分组隔离。

- 流量分离         

  务必将秒杀系统与其他业务系统的流量进行分离。

##### 1.2 限流之道

- 提前预约秒杀

  在参与抢购的用户基数上进行控制，减少秒杀的峰值流量

- 打散客户端流量

  PC、H5、APP和小程序，设置答题，验证码，滑块等方式将流量打散

- 消息队列

  使用消息队列来削峰填谷

  ```
  前边的请求将商品的库存消耗完之后，在商品库库存的缓存中设置一个特殊占位符，让后续的请求能够快速失败，而不进行后续的业务逻辑处理
  ```

- 网关限流

  网关层对流量进行限流

- API限流

  对接口进行限流

  ```
  可以使用google提供的RateLimiter开源工具包
  ```

- 应用层限流

  通过对线程池的限流来实现，通过自定义线程池，配置最大的连接数，请求队列长度和拒绝策略等参数

- 安全校验

  识别哪些流量是安全流量，哪些是友商，黄牛党或者恶意刷单流量。

- 活动校验

  接受到请求时，对活动数据进行校验，核对活动是否已经结束、是否下架等等。

- 秒杀品校验

  对当前的商品信息进行校验

- 秒杀资格校验

  对参与秒杀的用户的资格进行校验。

- 风控校验

- 大厂策略

##### 1.3 快速响应之道

- 多用缓存

  前端和后端，避免发生缓存穿透和雪崩。

- 本地缓存

  热点数据缓存在本地的JVM内存中

- 分布式缓存

  本地缓存 -> 分布式缓存 -> 数据库

- 数据尽量少

  不要查询或返回无关紧要的数据

- 计算计算少

  尽量不涉及复杂的计算操作，消耗大量的CPU资源。

- 流程尽量简单

  流程越简单，处理的业务逻辑越少，性能就越高

##### 1.4 准确一致之道

- 缓存与数据库一致

  强一致性，弱一致性，最终一致性

- 本地缓存与分布式缓存一致

  热点数据

- 商品库存与订单一致

  超卖问题

- 前端与后端数据一致

  最终一致性

##### 1.5 稳定可靠之道

- 业务隔离

- 系统隔离

- 数据隔离

  redis,mysql单独部署

- 监控数据库与基础指标

  数据库，cpu使用率，内存，负载，网卡，磁盘，IO，网络波动

- 监控JVM指标

  YOUNG GC,FULL GC,堆栈，线程

- 监控中间件指标

##### 1.6 全链路压测之道

#### 2.扣减库存方案

- 只有商品剩余库存数量大于用户购买数量时，才扣减库存，否则提示库存不足。
- 在应用程序的事务中判断商品库存是否为负，如果是，则回滚事务不再扣减库存。
- 在数据库中设置库存字段为无符号整数，从数据库层面保证无法出现负数的情况。
